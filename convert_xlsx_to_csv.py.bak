#!/usr/bin/env python3
# -*- coding: utf-8 -*-
import pandas as pd
import os
import re
from pathlib import Path

INPUT_EXCEL = "raw/HKJ_local_results_20230910.xlsx"
OUTPUT_DIR = "data"
DEFAULT_RACE_DISTANCE = 1600
RACE_DISTANCES = {
    1: 1600,
    2: 1200,
    3: 1800,
    4: 1400,
    5: 2000,
    6: 1600,
    7: 1200,
    8: 1650,
}

def main():
    if not os.path.exists(INPUT_EXCEL):
        print(f"❌ 找不到輸入檔案: {INPUT_EXCEL}")
        return

    Path(OUTPUT_DIR).mkdir(exist_ok=True)
    excel_file = pd.ExcelFile(INPUT_EXCEL)
    sheet_names = excel_file.sheet_names

    for sheet in sheet_names:
        try:
            race_num_match = re.search(r'race(\d+)', sheet, re.IGNORECASE)
            if not race_num_match:
                continue
            race_number = int(race_num_match.group(1))
            df = pd.read_excel(INPUT_EXCEL, sheet_name=sheet, header=1, dtype=str)
            df.dropna(how='all', inplace=True)
            if df.empty:
                continue

            col_map = {'馬名': 'horse_name', '騎師': 'jockey', '練馬師': 'trainer',
                      '實際 負磅': 'actual_weight', '檔位': 'draw', '獨贏 賠率': 'win_odds'}
            available = [c for c in col_map.keys() if c in df.columns]
            if not available:
                continue

            df_clean = df[available].rename(columns=col_map)

            # 關鍵行：使用半形 ～
            df_clean = df_clean[
                ～df_clean['horse_name'].str.contains(r'WV|AE|NT|SCR', na=False, case=False)
            ]

            numeric_cols = ['actual_weight', 'draw', 'win_odds']
            for col in numeric_cols:
                if col in df_clean.columns:
                    df_clean[col] = (
                        df_clean[col].astype(str)
                        .str.replace(',', '').str.strip()
                    )
                    df_clean[col] = pd.to_numeric(df_clean[col], errors='coerce')
            df_clean.dropna(subset=numeric_cols, inplace=True)

            if df_clean.empty:
                continue

            distance = RACE_DISTANCES.get(race_number, DEFAULT_RACE_DISTANCE)
            df_clean['race_distance'] = distance

            output_file = os.path.join(OUTPUT_DIR, f"next_race_Race{race_number}.csv")
            df_clean.to_csv(output_file, index=False, encoding='utf-8',
                           columns=['horse_name','jockey','trainer',
                                   'actual_weight','draw','win_odds','race_distance'])
            print(f"✅ Race {race_number}: {len(df_clean)} 匹馬 -> {output_file}")

        except Exception as e:
            print(f"❌ 錯誤於 {sheet}: {e}")

if __name__ == "__main__":
    main()
