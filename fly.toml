# fly.toml ï¼ horse_racing_inf å¾Œç«¯ä¸»æœå‹™
# ç”Ÿæˆæ—¥æœŸï¼š2025-12-29  ğŸš€  ç¬¬ä¸€æ¬¡éƒ¨ç½²å‰ï¼Œè«‹å…ˆåŸ·è¡Œï¼š
#   fly apps create horse-racing-inf --org <ä½ çš„çµ„ç¹”å>

app = "horse-racing-inf"          # è‹¥åå­—è¢«ä½”ç”¨ï¼Œæ”¹æˆ horse-racing-inf-xyz
primary_region = "hkg"            # é›¢å°ç£/é¦™æ¸¯æœ€è¿‘ï¼›å¯æ”¹ nrtã€sinã€iadâ€¦
kill_signal = "SIGTERM"
kill_timeout = "30s"

[experimental]
  auto_rollback = true            # éƒ¨ç½²å¤±æ•—è‡ªå‹•å›æ»¾

[build]
  # â¶ Docker å°ˆæ¡ˆç”¨é€™è¡Œï¼ˆDockerfile åœ¨æ ¹ç›®éŒ„ï¼‰
  dockerfile = "Dockerfile"

  # â· è‹¥æ˜¯ Python ç´”å°ˆæ¡ˆï¼Œæ²’ Dockerfileï¼Œå¯æ”¹ç”¨ buildpackï¼š
  # builder = "paketobuildpacks/builder:base"

[env]
  # æ”¾ã€Œéæ©Ÿå¯†ã€çš„é è¨­å€¼ï¼›æ©Ÿå¯†è«‹ç”¨ `fly secrets set KEY=val`
  PORT = "8080"
  PYTHONUNBUFFERED = "1"
  ENV = "production"
  LOG_LEVEL = "info"
  # è³‡æ–™åº«é€£ç·šå­—å…ƒç·¨ç¢¼
  DATABASE_CHARSET = "utf8mb4"

[http_service]
  internal_port = 8080            # å¿…é ˆèˆ‡ä¸Šé¢ PORT ä¸€è‡´
  force_https = true              # è‡ªå‹• httpâ†’https
  auto_stop_machines = "stop"     # æ²’æµé‡æ™‚é—œæ©ŸçœéŒ¢
  auto_start_machines = true
  min_machines_running = 0        # æƒ³ä¿æŒ 1 å°ç†±æ©Ÿå¯æ”¹ 1
  processes = ["app"]

  # å¥åº·æª¢æŸ¥ â”€â”€ æˆåŠŸæ‰å°å¤–æµé‡
  [http_service.checks]
    [http_service.checks.alive]
      grace_period = "15s"
      interval = "30s"
      method = "GET"
      path = "/healthz"           # â† åœ¨ç¨‹å¼è£¡å¯¦ä½œé€™æ”¯ API
      timeout = "5s"
      tls_skip_verify = false

# è‹¥éœ€è¦ TCP / gRPC é¡å¤–ç«¯å£ï¼Œå¯å†é–‹ä¸€çµ„ [[services]]
# [[services]]
#   internal_port = 9000
#   protocol = "tcp"
#   auto_stop_machines = true
#   auto_start_machines = true
#   [[services.ports]]
#     port = 9000

# æ›è¼‰æ°¸ä¹…ç£ç¢Ÿï¼ˆè³‡æ–™åº«ã€logsã€æ¨¡å‹æ¬Šé‡â€¦ï¼‰
# ç¬¬ä¸€æ¬¡å…ˆ `fly volume create horse_data --region hkg --size 3`
[mounts]
  source = "horse_data"
  destination = "/data"
  processes = ["app"]

# è³‡æºé™åˆ¶ â”€â”€ ä¾å…è²»é¡åº¦/å¯¦æ¸¬èª¿æ•´
[[vm]]
  cpu_kind = "shared"
  cpus = 1
  memory_mb = 512                 # Python + è¼•é‡ DB å¤ ç”¨ï¼›ä¸å¤ å†èª¿ 1024

# è‹¥éœ€è¦ã€Œå¤šç¨‹åºã€æ¶æ§‹ï¼ˆworker / schedulerï¼‰ï¼Œåœ¨é€™è£¡åŠ 
# [processes]
#   app = "gunicorn -w 4 -b 0.0.0.0:8080 app:app"
#   worker = "celery -A tasks worker --loglevel=info"
# ç„¶å¾Œåœ¨ [[vm]] æˆ– [http_service] è£¡ç”¨ processes æŒ‡å®š
