# .github/workflows/deploy.yml
name: CD â†’ VPS ä¸€éµéƒ¨ç½²

on:
  push:
    branches: [main]
  workflow_dispatch:          # æ‰‹å‹•è§¸ç™¼æŒ‰éˆ•

env:
  # ä»¥ä¸‹ 4 å€‹å€¼è«‹åœ¨ Settings â†’ Secrets and variables â†’ Actions æ–°å¢
  # SSH_KEY        : å¯ç™»å…¥ VPS çš„ private key (å®Œæ•´å«é ­å°¾)
  # VPS_HOST       : IP æˆ–åŸŸåï¼Œä¾‹å¦‚ 1.2.3.4
  # VPS_USER       : ç™»å…¥å¸³è™Ÿï¼Œä¾‹å¦‚ root æˆ– ubuntu
  # SLACK_WEBHOOK  : https://hooks.slack.com/services/...
  IMAGE_NAME: horse-racing-inf
  CONTAINER_NAME: horse-racing-inf
  DEPLOY_PATH: /opt/horse-racing-inf   # é ç«¯å°ˆæ¡ˆç›®éŒ„

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # ---------- 1. æ‹‰åŸå§‹ç¢¼ ----------
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- 2. ç™»éŒ„ Docker Hubï¼ˆå¯æ”¹ GHCRï¼‰ ----------
      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}   # å¯é¸
          password: ${{ secrets.DOCKERHUB_TOKEN }}      # å¯é¸

      # ---------- 3. å»ºç½®æ˜ åƒä¸¦æ¨ä¸Š registry ----------
      - name: Build & push
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      # ---------- 4. è¨­å®š SSH ----------
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_KEY }}" > ~/.ssh/id_vps
          chmod 600 ~/.ssh/id_vps
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      # ---------- 5. åŒæ­¥æª”æ¡ˆï¼ˆdocker-compose.yml ç­‰ï¼‰ ----------
      - name: Rsync repo to VPS
        run: |
          rsync -avz --delete \
            -e "ssh -i ~/.ssh/id_vps -o StrictHostKeyChecking=no" \
            --exclude='.git/' --exclude='node_modules/' \
            ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ env.DEPLOY_PATH }}

      # ---------- 6. é ç«¯é‡å•Ÿå®¹å™¨ ----------
      - name: Deploy container
        run: |
          ssh -i ~/.ssh/id_vps -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            set -e
            cd ${{ env.DEPLOY_PATH }}

            # æ‹‰æœ€æ–°æ˜ åƒ
            docker pull ${{ secrets.DOCKERHUB_USERNAME }}/${{ env.IMAGE_NAME }}:latest

            # ç”¨ docker-compose é‡å•Ÿï¼ˆé›¶åœæ©Ÿï¼‰
            docker compose -f docker-compose.yml up -d --remove-orphans

            # ç­‰å¾…å®¹å™¨å¥åº·
            for i in {1..10}; do
              if [ "$(docker inspect -f '{{.State.Health.Status}}' ${{ env.CONTAINER_NAME }} 2>/dev/null)" == "healthy" ]; then
                echo "âœ… Health check passed"
                exit 0
              fi
              sleep 5
            done
            echo "âŒ Container not healthy"
            exit 1
          EOF

      # ---------- 7. é€šçŸ¥ Slack ----------
      - name: Slack notification
        if: always()
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          text: |
            ${{ job.status == 'success' && 'ğŸŸ¢ éƒ¨ç½²æˆåŠŸ' || 'ğŸ”´ éƒ¨ç½²å¤±æ•—' }}  
            `${{ github.event.head_commit.message }}`
          webhook_url: ${{ secrets.SLACK_WEBHOOK }}
